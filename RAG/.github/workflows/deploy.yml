name: Deploy to EC2

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      EC2_HOST: ${{ secrets.EC2_HOST }}
      EC2_USERNAME: ${{ secrets.EC2_USERNAME }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      APP_DIR: /home/ubuntu/app
      VENV_DIR: /home/ubuntu/venv
      LOG_FILE: /home/ubuntu/app.log
      PID_FILE: /home/ubuntu/app.pid
      MAX_RETRIES: 15
      RETRY_INTERVAL: 3

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      - name: Add EC2 to known hosts
        run: |
          ssh-keyscan -H $EC2_HOST >> ~/.ssh/known_hosts

      - name: Deploy application files
        run: |
          echo "ğŸš€ Creating app directory and transferring files..."
          ssh $EC2_USERNAME@$EC2_HOST "mkdir -p $APP_DIR"
          rsync -avz --delete \
            --exclude='__pycache__' \
            --exclude='*.pyc' \
            --exclude='.git' \
            api/app/ $EC2_USERNAME@$EC2_HOST:$APP_DIR/
          echo "âœ… Files transferred"

      - name: Setup virtual environment & start app
        run: |
          echo "ğŸ”§ Setting up virtual environment and starting application..."
          ssh $EC2_USERNAME@$EC2_HOST bash << ENDSSH
            set -e

            # ë³€ìˆ˜ ì„¤ì •
            APP_DIR=/home/ubuntu/app
            VENV_DIR=/home/ubuntu/venv
            LOG_FILE=/home/ubuntu/app.log
            PID_FILE=/home/ubuntu/app.pid
            OPENAI_API_KEY_VALUE="$OPENAI_API_KEY"

            cd /home/ubuntu

            # ê°€ìƒí™˜ê²½ ìƒì„±
            if [ ! -d "$VENV_DIR" ]; then
              echo "ğŸ“¦ Creating virtual environment..."
              python3 -m venv $VENV_DIR
            else
              echo "âœ… Virtual environment exists"
            fi

            # íŒ¨í‚¤ì§€ ì„¤ì¹˜
            echo "ğŸ“¥ Installing/upgrading packages..."
            source $VENV_DIR/bin/activate
            pip install --upgrade pip --no-cache-dir

            # CPU ì „ìš© torch ë¨¼ì € ì„¤ì¹˜ (ë””ìŠ¤í¬ ê³µê°„ ì ˆì•½)
            pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cpu --no-cache-dir

            # ë‚˜ë¨¸ì§€ íŒ¨í‚¤ì§€ ì„¤ì¹˜
            pip install -r $APP_DIR/requirements.txt --upgrade --no-cache-dir

            # ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ
            echo "ğŸ›‘ Stopping existing application..."
            pkill -f "python.*main.py" || true
            pkill -f "$VENV_DIR/bin/python.*main.py" || true
            sleep 2

            # ì•± ì‹œì‘
            echo "ğŸš€ Starting application..."
            cd $APP_DIR

            # Python ê²½ë¡œ ì„¤ì • (app.model importë¥¼ ìœ„í•´)
            export PYTHONPATH="$APP_DIR:\$PYTHONPATH"

            # í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
            export OPENAI_API_KEY="\$OPENAI_API_KEY_VALUE"
            export HOST=0.0.0.0
            export PORT=8000
            export MODE=api

            # ë¡œê·¸ íŒŒì¼ ë¯¸ë¦¬ ìƒì„±
            touch $LOG_FILE

            # ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰
            nohup $VENV_DIR/bin/python main.py > $LOG_FILE 2>&1 &
            APP_PID=\$!
            echo \$APP_PID > $PID_FILE
            echo "âœ… Application started (PID: \$APP_PID)"

            # í”„ë¡œì„¸ìŠ¤ ì‹œì‘ í™•ì¸
            sleep 3
            if ps -p \$APP_PID > /dev/null 2>&1; then
              echo "âœ… Process is running"

              # í¬íŠ¸ ì²´í¬
              sleep 2
              if ss -tlnp 2>/dev/null | grep :8000 || netstat -tlnp 2>/dev/null | grep :8000; then
                echo "âœ… Port 8000 is listening"
              else
                echo "âš ï¸ Port 8000 not listening yet, checking logs..."
                tail -30 $LOG_FILE 2>/dev/null || echo "No log file found"
              fi
            else
              echo "âŒ Application failed to start. Checking logs..."
              tail -50 $LOG_FILE 2>/dev/null || echo "No log file found"
              exit 1
            fi
          ENDSSH

      - name: Health check
        run: |
          echo "ğŸ¥ Running health check..."
          for i in $(seq 1 $MAX_RETRIES); do
            echo "â³ Attempt $i/$MAX_RETRIES..."

            # í”„ë¡œì„¸ìŠ¤ í™•ì¸
            if ssh $EC2_USERNAME@$EC2_HOST "ps -p \$(cat $PID_FILE 2>/dev/null) > /dev/null 2>&1"; then
              # Health check
              if ssh $EC2_USERNAME@$EC2_HOST "curl -f http://localhost:8000/health > /dev/null 2>&1"; then
                echo "âœ… Health check passed!"
                exit 0
              else
                echo "âš ï¸ Health check failed, but process is running. Retrying..."
              fi
            else
              echo "âŒ Process not found. Checking logs..."
              ssh $EC2_USERNAME@$EC2_HOST "tail -50 $LOG_FILE 2>/dev/null || echo 'No log file'"
            fi

            # ë§ˆì§€ë§‰ ì‹œë„ê°€ ì•„ë‹ˆë©´ ëŒ€ê¸°
            if [ $i -lt $MAX_RETRIES ]; then
              sleep $RETRY_INTERVAL
            fi
          done

          echo "âŒ Health check failed after $MAX_RETRIES attempts. Showing diagnostics..."
          ssh $EC2_USERNAME@$EC2_HOST << 'ENDSSH'
            echo "--- Process Status ---"
            ps aux | grep -E "python.*main.py" | grep -v grep || echo "No process found"
            echo ""
            echo "--- Last 100 lines of logs ---"
            tail -100 /home/ubuntu/app.log 2>/dev/null || echo "No log file found"
            echo ""
            echo "--- Port 8000 status ---"
            ss -tlnp 2>/dev/null | grep :8000 || netstat -tlnp 2>/dev/null | grep :8000 || echo "Port 8000 not listening"
            echo ""
            echo "--- PID file ---"
            cat /home/ubuntu/app.pid 2>/dev/null || echo "No PID file found"
          ENDSSH
          exit 1
