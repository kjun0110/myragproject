name: Deploy to EC2

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # GitHub ë ˆí¬ì§€í† ë¦¬ ì „ì²´ ì²´í¬ì•„ì›ƒ
      - name: Checkout code
        uses: actions/checkout@v4

      # SSH í‚¤ ì„¤ì • (EC2 ì ‘ì†ìš©)
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      # EC2 í˜¸ìŠ¤íŠ¸ë¥¼ known_hostsì— ì¶”ê°€ (SSH ì—°ê²° ì‹œ í˜¸ìŠ¤íŠ¸ ê²€ì¦)
      - name: Add EC2 to known hosts
        run: |
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      # api/app í´ë”ë¥¼ EC2ì˜ /home/ubuntu/appìœ¼ë¡œ ë°°í¬
      - name: Deploy to EC2
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USERNAME: ${{ secrets.EC2_USERNAME }}
        run: |
          echo "ğŸš€ Starting deployment to EC2..."

          # app ë””ë ‰í† ë¦¬ ìƒì„± (ì—†ìœ¼ë©´ ìë™ ìƒì„±)
          ssh $EC2_USERNAME@$EC2_HOST "mkdir -p ~/app"

          # api/app í´ë”ë§Œ EC2ì˜ /home/ubuntu/appìœ¼ë¡œ rsync ì „ì†¡
          echo "ğŸ“¦ Transferring api/app files to EC2..."
          rsync -avz --delete \
            --exclude='__pycache__' \
            --exclude='*.pyc' \
            --exclude='.git' \
            api/app/ $EC2_USERNAME@$EC2_HOST:~/app/

          echo "âœ… File transfer completed!"

      # ê°€ìƒí™˜ê²½ ìƒì„± ë° íŒ¨í‚¤ì§€ ì„¤ì¹˜, ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰
      - name: Setup virtual environment and run application
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USERNAME: ${{ secrets.EC2_USERNAME }}
        run: |
          echo "ğŸ”§ Setting up virtual environment and starting application..."

          # ê°€ìƒí™˜ê²½ ìƒì„± (ì—†ìœ¼ë©´), íŒ¨í‚¤ì§€ ì„¤ì¹˜, ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰
          ssh $EC2_USERNAME@$EC2_HOST << 'ENDSSH'
            set -e  # ì˜¤ë¥˜ ë°œìƒ ì‹œ ìŠ¤í¬ë¦½íŠ¸ ì¤‘ë‹¨
            cd /home/ubuntu

            # venvê°€ ì—†ìœ¼ë©´ ìƒì„± (python3 ëª…ì‹œì  ì‚¬ìš©)
            if [ ! -d "venv" ]; then
              echo "ğŸ“¦ Creating virtual environment with python3..."
              python3 -m venv venv
            else
              echo "âœ… Virtual environment already exists"
            fi

            # ê°€ìƒí™˜ê²½ì˜ pipë¥¼ ì§ì ‘ ì‚¬ìš©í•˜ì—¬ íŒ¨í‚¤ì§€ ì„¤ì¹˜ (í™œì„±í™” ì—†ì´)
            echo "ğŸ“¥ Installing/upgrading packages..."
            /home/ubuntu/venv/bin/pip install --upgrade pip
            /home/ubuntu/venv/bin/pip install -r /home/ubuntu/requirements.txt --upgrade

            # ê¸°ì¡´ main.py í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ (python3ì™€ ê°€ìƒí™˜ê²½ python ëª¨ë‘ í™•ì¸)
            echo "ğŸ›‘ Stopping existing application..."
            pkill -f "python.*main.py" || true
            pkill -f "python3.*main.py" || true
            pkill -f "/home/ubuntu/venv/bin/python.*main.py" || true
            sleep 3

            # ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰ (ê°€ìƒí™˜ê²½ì˜ python ì§ì ‘ ì‚¬ìš©, ì ˆëŒ€ ê²½ë¡œë¡œ ë¡œê·¸ ì €ì¥)
            echo "ğŸš€ Starting application..."
            cd /home/ubuntu/app
            HOST=0.0.0.0 PORT=8000 MODE=api nohup /home/ubuntu/venv/bin/python main.py > /home/ubuntu/app.log 2>&1 &
            APP_PID=$!
            echo $APP_PID > /home/ubuntu/app.pid

            # í”„ë¡œì„¸ìŠ¤ê°€ ì‹¤ì œë¡œ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸
            sleep 2
            if ps -p $APP_PID > /dev/null 2>&1; then
              echo "âœ… Application started successfully (PID: $APP_PID)"
            else
              echo "âŒ Application failed to start. Checking logs..."
              tail -50 /home/ubuntu/app.log || echo "No log file found"
              exit 1
            fi
          ENDSSH

          echo "âœ… Deployment completed!"

      # í—¬ìŠ¤ ì²´í¬ (ì• í”Œë¦¬ì¼€ì´ì…˜ ì •ìƒ ì‹¤í–‰ í™•ì¸, ì¬ì‹œë„ 10íšŒ, 3ì´ˆ ê°„ê²©)
      - name: Health Check
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USERNAME: ${{ secrets.EC2_USERNAME }}
        run: |
          echo "ğŸ¥ Running health check..."
          MAX_RETRIES=10
          RETRY_INTERVAL=3
          RETRY_COUNT=0

          # ì´ˆê¸° ëŒ€ê¸° ì‹œê°„ (ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ì‹œê°„ í™•ë³´)
          echo "â³ Waiting for application to start..."
          sleep 5

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            # curlì´ ì„¤ì¹˜ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•˜ê³ , ì—†ìœ¼ë©´ wget ì‚¬ìš©
            if ssh $EC2_USERNAME@$EC2_HOST "command -v curl > /dev/null 2>&1 && curl -f http://localhost:8000/health > /dev/null 2>&1 || command -v wget > /dev/null 2>&1 && wget -q --spider http://localhost:8000/health > /dev/null 2>&1"; then
              echo "âœ… Health check passed!"
              exit 0
            else
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "â³ Health check failed. Retry $RETRY_COUNT/$MAX_RETRIES (waiting ${RETRY_INTERVAL}s)..."
                sleep $RETRY_INTERVAL
              fi
            fi
          done

          echo "âŒ Health check failed after $MAX_RETRIES attempts"
          echo "ğŸ“‹ Checking application status..."
          ssh $EC2_USERNAME@$EC2_HOST << 'ENDSSH'
            echo "--- Process Status ---"
            ps aux | grep -E "python.*main.py|uvicorn" | grep -v grep || echo "No application process found"
            echo ""
            echo "--- Application Logs (last 50 lines) ---"
            tail -50 /home/ubuntu/app.log 2>/dev/null || echo "No log file found at /home/ubuntu/app.log"
            echo ""
            echo "--- Port 8000 Status ---"
            netstat -tlnp 2>/dev/null | grep :8000 || ss -tlnp 2>/dev/null | grep :8000 || echo "Port 8000 not listening"
          ENDSSH
          exit 1
