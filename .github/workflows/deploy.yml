name: Deploy to EC2

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # GitHub ë ˆí¬ì§€í† ë¦¬ ì „ì²´ ì²´í¬ì•„ì›ƒ
      - name: Checkout code
        uses: actions/checkout@v4

      # SSH í‚¤ ì„¤ì • (EC2 ì ‘ì†ìš©)
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      # EC2 í˜¸ìŠ¤íŠ¸ë¥¼ known_hostsì— ì¶”ê°€ (SSH ì—°ê²° ì‹œ í˜¸ìŠ¤íŠ¸ ê²€ì¦)
      - name: Add EC2 to known hosts
        run: |
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      # api/app í´ë”ë¥¼ EC2ì˜ /home/ubuntu/appìœ¼ë¡œ ë°°í¬
      - name: Deploy to EC2
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USERNAME: ${{ secrets.EC2_USERNAME }}
        run: |
          echo "ğŸš€ Starting deployment to EC2..."

          # app ë””ë ‰í† ë¦¬ ìƒì„± (ì—†ìœ¼ë©´ ìë™ ìƒì„±)
          ssh $EC2_USERNAME@$EC2_HOST "mkdir -p ~/app"

          # api/app í´ë”ë§Œ EC2ì˜ /home/ubuntu/appìœ¼ë¡œ rsync ì „ì†¡
          echo "ğŸ“¦ Transferring api/app files to EC2..."
          rsync -avz --delete \
            --exclude='__pycache__' \
            --exclude='*.pyc' \
            --exclude='.git' \
            api/app/ $EC2_USERNAME@$EC2_HOST:~/app/

          echo "âœ… File transfer completed!"

      # ê°€ìƒí™˜ê²½ ìƒì„± ë° íŒ¨í‚¤ì§€ ì„¤ì¹˜, ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰
      - name: Setup virtual environment and run application
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USERNAME: ${{ secrets.EC2_USERNAME }}
        run: |
          echo "ğŸ”§ Setting up virtual environment and starting application..."

          # ê°€ìƒí™˜ê²½ ìƒì„± (ì—†ìœ¼ë©´), íŒ¨í‚¤ì§€ ì„¤ì¹˜, ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰
          ssh $EC2_USERNAME@$EC2_HOST << 'ENDSSH'
            cd /home/ubuntu

            # venvê°€ ì—†ìœ¼ë©´ ìƒì„±
            if [ ! -d "venv" ]; then
              echo "ğŸ“¦ Creating virtual environment..."
              python3 -m venv venv
            else
              echo "âœ… Virtual environment already exists"
            fi

            # ê°€ìƒí™˜ê²½ í™œì„±í™” ë° íŒ¨í‚¤ì§€ ì„¤ì¹˜
            echo "ğŸ“¥ Installing/upgrading packages..."
            source venv/bin/activate
            pip install -r requirements.txt --upgrade

            # ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ (ì´ë¯¸ ì‹¤í–‰ ì¤‘ì¸ ê²½ìš°)
            echo "ğŸ›‘ Stopping existing application..."
            pkill -f "python.*main.py" || true
            sleep 2

            # ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰ (ë°±ê·¸ë¼ìš´ë“œ)
            echo "ğŸš€ Starting application..."
            cd app
            nohup python main.py > ../app.log 2>&1 &
            echo $! > ../app.pid

            echo "âœ… Application started (PID: $(cat ../app.pid))"
          ENDSSH

          echo "âœ… Deployment completed!"

      # í—¬ìŠ¤ ì²´í¬ (ì• í”Œë¦¬ì¼€ì´ì…˜ ì •ìƒ ì‹¤í–‰ í™•ì¸)
      - name: Health Check
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USERNAME: ${{ secrets.EC2_USERNAME }}
        run: |
          echo "ğŸ¥ Running health check..."
          sleep 10
          ssh $EC2_USERNAME@$EC2_HOST "curl -f http://localhost:8000/health || exit 1"
          echo "âœ… Health check passed!"
